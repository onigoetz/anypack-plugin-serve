<!doctype html>
<html lang="en">
  <head>
    <title>Test page</title>

    <style>
      body {
        font-family: sans-serif;
      }

      button {
        border: 1px solid #333;
        border-radius: 4px;
        background: #00c889;
        padding: 4px 8px;
      }

      button:hover {
        cursor: pointer;
        border: 1px solid #00c889;
      }
    </style>
  </head>
  <body>
    <ul>
      <li><button id="compiler-add">Add compiler</button></li>

      <li>
        <strong>Compilation Errors</strong>
        <ul>
          <li><button id="error-add">Add error</button></li>
          <li><button id="error-clear">Clear errors</button></li>
        </ul>
      </li>

      <li>
        <strong>Compilation progress</strong>
        <ul>
          <li><button id="progress-start">In progress</button></li>
          <li><button id="progress-done">Done</button></li>
        </ul>
      </li>

      <li>
        <strong>Runtime</strong>
        <ul>
          <li><button id="runtime-add">Add runtime error</button></li>
        </ul>
      </li>
    </ul>

    <script type="module">
      import { init } from "./dist/index.js";

      class Compiler {
        state = {
          name: "Compiler 1",
          connected: true,
          compiler: {
            done: true,
            progress: 1,
            errors: [],
            warnings: [],
          },
        };

        listeners = [];
        onChange(callback) {
          this.listeners.push(callback);
        }

        broadcastUpdate() {
          for (const listener of this.listeners) {
            listener(this.state);
          }
        }
      }

      const possibleErrors = [
        {
          loc: "2:0-17",
          message:
            "Module not found: Error: Can't resolve './FILE' in '<cwd>/test/fixtures/errors'",
          moduleId: "./case-sensitive.js",
          moduleIdentifier: "<cwd>/test/fixtures/errors/case-sensitive.js",
          moduleName: "./case-sensitive.js",
          moduleTrace: [],
          stack:
            "ModuleNotFoundError: Module not found: Error: Can't resolve './FILE' in '<cwd>/test/fixtures/errors'",
        },
        {
          message:
            "There are multiple modules with names that only differ in casing.\nThis can lead to unexpected behavior when compiling on a filesystem with other case-semantic.\nUse equal casing. Compare these module identifiers:\n* <cwd>/test/fixtures/errors/FILE.js\n    Used by 1 module(s), i. e.\n    <cwd>/test/fixtures/errors/case-sensitive.js\n* <cwd>/test/fixtures/errors/file.js\n    Used by 1 module(s), i. e.\n    <cwd>/test/fixtures/errors/case-sensitive.js",
          moduleId: "./FILE.js",
          moduleIdentifier: "<cwd>/test/fixtures/errors/FILE.js",
          moduleName: "./FILE.js",
          moduleTrace: [
            {
              dependencies: [
                {
                  loc: "2:0-17",
                },
              ],
              moduleId: "./FILE.js",
              moduleIdentifier: "<cwd>/test/fixtures/errors/FILE.js",
              moduleName: "./FILE.js",
              originId: "./case-sensitive.js",
              originIdentifier: "<cwd>/test/fixtures/errors/case-sensitive.js",
              originName: "./case-sensitive.js",
            },
          ],
          stack:
            "CaseSensitiveModulesWarning: There are multiple modules with names that only differ in casing.\nThis can lead to unexpected behavior when compiling on a filesystem with other case-semantic.\nUse equal casing. Compare these module identifiers:\n* <cwd>/test/fixtures/errors/FILE.js\n    Used by 1 module(s), i. e.\n    <cwd>/test/fixtures/errors/case-sensitive.js\n* <cwd>/test/fixtures/errors/file.js\n    Used by 1 module(s), i. e.\n    <cwd>/test/fixtures/errors/case-sensitive.js",
        },
        {
          loc: "2:0-17",
          message:
            "Module not found: Error: Can't resolve './FILE' in '<cwd>/test/fixtures/errors'",
          moduleId: "./case-sensitive.js",
          moduleIdentifier: "<cwd>/test/fixtures/errors/case-sensitive.js",
          moduleName: "./case-sensitive.js",
          moduleTrace: [],
          stack:
            "ModuleNotFoundError: Module not found: Error: Can't resolve './FILE' in '<cwd>/test/fixtures/errors'",
        },
        {
          message:
            "configuration\nThe 'mode' option has not been set, webpack will fallback to 'production' for this value.\nSet 'mode' option to 'development' or 'production' to enable defaults for each environment.\nYou can also set it to 'none' to disable any default behavior. Learn more: https://webpack.js.org/configuration/mode/",
          stack:
            "NoModeWarning: configuration\nThe 'mode' option has not been set, webpack will fallback to 'production' for this value.\nSet 'mode' option to 'development' or 'production' to enable defaults for each environment.\nYou can also set it to 'none' to disable any default behavior. Learn more: https://webpack.js.org/configuration/mode/",
        },
        {
          loc: "2:12",
          message:
            "Module parse failed: Unexpected token (2:12)\nYou may need an appropriate loader to handle this file type, currently no loaders are configured to process this file. See https://webpack.js.org/concepts#loaders\n| window.foo = {\n>   bar: true,;\n| };\n| ",
          moduleId: 0,
          moduleIdentifier: "<cwd>/test/fixtures/errors/has-syntax-error.js",
          moduleName: "./has-syntax-error.js",
          moduleTrace: [],
          stack:
            "ModuleParseError: Module parse failed: Unexpected token (2:12)\nYou may need an appropriate loader to handle this file type, currently no loaders are configured to process this file. See https://webpack.js.org/concepts#loaders\n| window.foo = {\n>   bar: true,;\n| };\n| ",
        },
        {
          message: `× Module build failed (from builtin:swc-loader):
    ├─▶   ×   × Expected corresponding JSX closing tag for <h1>
    │     │    ╭─[/Users/onigoetz/Sites/forks/anypack-plugin-serve/recipes/react-rspack/src/App.js:6:1]
    │     │  3 │ import './style.css';
    │     │  4 │
    │     │  5 │ export default function App() {
    │     │  6 │   return <h1>Hi my world!</h2>;
    │     │    ·                            ──
    │     │  7 │ }
    │     │    ╰────
    │     │
    │   
    ╰─▶   × Syntax Error`,
          moduleIdentifier: "src/App.js",
        },
      ];

      const manager = init();

      const compiler = new Compiler();
      manager.addCompiler(compiler);
      const compilers = [compiler];

      document.getElementById("compiler-add").addEventListener("click", () => {
        const compiler = new Compiler();
        manager.addCompiler(compiler);
        compilers.push(compiler);
      });
      document.getElementById("error-add").addEventListener("click", () => {
        const compiler =
          compilers[Math.floor(Math.random() * compilers.length)];
        compiler.state.compiler[Math.random() > 0.5 ? "warnings" : "errors"].push(
          possibleErrors[Math.floor(Math.random() * possibleErrors.length)],
        );
        compiler.broadcastUpdate();
      });
      document.getElementById("error-clear").addEventListener("click", () => {
        for (const compiler of compilers) {
          compiler.state.compiler.errors = [];
          compiler.state.compiler.warnings = [];
          compiler.broadcastUpdate();
        }
      });
      document
        .getElementById("progress-start")
        .addEventListener("click", () => {
          const compiler =
            compilers[Math.floor(Math.random() * compilers.length)];
          compiler.state.compiler.progress = 0.83;
          compiler.state.compiler.done = false;
          compiler.broadcastUpdate();
        });
      document.getElementById("progress-done").addEventListener("click", () => {
        for (const compiler of compilers) {
          compiler.state.compiler.done = true;
          compiler.state.compiler.progress = 1;
          compiler.broadcastUpdate();
        }
      });

      document.getElementById("runtime-add").addEventListener("click", () => {
        throw new Error("Whoops!");
      });

      console.log(manager);
    </script>
  </body>
</html>
